<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Internship Data Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css" />
    <!-- Remove compression library -->
    <style>
      #jobMap {
        height: 500px;
        width: 100%;
        margin: 20px 0;
        background: #2e2e2e;
        /* Visual indicator that container exists */
        border: 1px solid #666;
        /* Makes container visible */
      }

      .map-container {
        padding: 20px;
        background: #1e1e1e;
        margin: 20px;
        border-radius: 8px;
      }

      .location-stats {
        color: #ffffff;
        margin-top: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }
    </style>
  </head>

  <body class="bg-[#121212] text-[#FFFFFF]">
    <div id="authHeader" class="auth-header">
      <div class="user-info">
        <span id="userName"></span>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Add navigation menu -->
    <div id="navMenu" class="nav-menu">
      <a href="jobs.html">Jobs</a>
      <a href="analytics.html">Analytics</a>
    </div>
    <h1 class="text-3xl font-bold text-center my-8 text-[#FFFFFF]">
      Internship Data Analytics Dashboard
    </h1>

    <div
      class="stats-container clear-both p-5 m-5 bg-[#1E1E1E] rounded"
      id="summary-stats"
    >
      <h2 class="text-2xl font-semibold mb-4 text-[#FFFFFF]">
        Summary Statistics
      </h2>
      <table class="w-full text-left border-collapse">
        <thead>
          <tr>
            <th class="py-2 px-4 bg-[#282828] border-b border-[#404040]"></th>
            <th class="py-2 px-4 bg-[#282828] border-b border-[#404040]">
              Today
            </th>
            <th class="py-2 px-4 bg-[#282828] border-b border-[#404040]">
              Total
            </th>
          </tr>
        </thead>
        <tbody id="statsTable">
          <tr>
            <td class="py-2 px-4 border-b border-[#404040]">
              Total Applications
            </td>
            <td class="py-2 px-4 border-b border-[#404040]" id="todayApps">
              -
            </td>
            <td class="py-2 px-4 border-b border-[#404040]" id="totalApps">
              -
            </td>
          </tr>
          <tr>
            <td class="py-2 px-4 border-b border-[#404040]">
              Unique Companies
            </td>
            <td class="py-2 px-4 border-b border-[#404040]" id="todayCompanies">
              -
            </td>
            <td class="py-2 px-4 border-b border-[#404040]" id="totalCompanies">
              -
            </td>
          </tr>
          <tr>
            <td class="py-2 px-4 border-b border-[#404040]">Rejections</td>
            <td
              class="py-2 px-4 border-b border-[#404040]"
              id="todayRejections"
            >
              -
            </td>
            <td
              class="py-2 px-4 border-b border-[#404040]"
              id="totalRejections"
            >
              -
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="full-width-chart">
      <h2 class="text-2xl font-semibold mb-4 text-[#FFFFFF]">
        Daily Application Analysis
      </h2>
      <div class="chart-controls mb-4">
        <button
          data-value="7"
          class="bg-[#7C3AED] text-[#FFFFFF] px-4 py-2 rounded mr-2 hover:bg-[#6D28D9]"
        >
          Last 7 Days
        </button>
        <button
          data-value="14"
          class="bg-[#7C3AED] text-[#FFFFFF] px-4 py-2 rounded mr-2 hover:bg-[#6D28D9]"
        >
          Last 14 Days
        </button>
        <button
          data-value="30"
          class="bg-[#7C3AED] text-[#FFFFFF] px-4 py-2 rounded mr-2 hover:bg-[#6D28D9]"
        >
          Last 30 Days
        </button>
        <button
          data-value="60"
          class="bg-[#7C3AED] text-[#FFFFFF] px-4 py-2 rounded mr-2 hover:bg-[#6D28D9]"
        >
          Last 2 Months
        </button>
        <button
          data-value="all"
          class="bg-[#7C3AED] text-[#FFFFFF] px-4 py-2 rounded hover:bg-[#6D28D9]"
        >
          All Time
        </button>
      </div>
      <div class="chart-scroll-container overflow-x-auto pb-4 h-5/6">
        <canvas id="dailyApplicationsChart" class="h-[700px]"></canvas>
      </div>
    </div>

    <div class="map-container">
      <h2 class="text-2xl font-semibold mb-4 text-[#FFFFFF]">
        Job Locations Map
      </h2>
      <div id="jobMap"></div>
      <div class="location-stats" id="locationStats"></div>
    </div>

    <div
      class="chart-container w-1/2 m-5 p-4 border border-[#282828] rounded bg-[#1E1E1E]"
    >
      <h2 class="text-xl font-semibold mb-2 text-[#FFFFFF]">
        Salary Distribution (Hourly Only)
      </h2>
      <canvas id="salaryChart"></canvas>
    </div>

    <div class="chart-container w-1/2 m-5 p-4 border border-[#282828] rounded bg-[#1E1E1E]">
      <h2 class="text-xl font-semibold mb-2 text-[#FFFFFF]">Salary Distribution (All)</h2>
      <canvas id="salaryChartAll"></canvas>
    </div>

    <script>
      // Simplified data loading
      async function loadData() {
        try {
          const response = await fetch(
            "https://raw.githubusercontent.com/abhira0/Summer2025-Internships/dev/docs/analytics/cache/simplify/parsed.json"
          );
          const data = await response.json();

          // Initialize all visualizations
          displaySummaryStats(data);
          createSalaryChart(data);
          createDailyApplicationsChart(data);
          createJobMap(data);
        } catch (error) {
          console.error("Error loading data:", error);
        }
      }

      // Load data when page loads
      window.addEventListener("load", loadData);

      // Keep existing visualization functions
      function displaySummaryStats(data) {
        const today = new Date().toISOString().split("T")[0];

        // Calculate applications
        const totalApps = data.length;
        const todayApps = data.filter(
          (job) => job.tracked_date && job.tracked_date.startsWith(today)
        ).length;

        // Calculate unique companies
        const totalCompanies = new Set(data.map((job) => job.company_id)).size;
        const todayCompanies = new Set(
          data
            .filter(
              (job) => job.tracked_date && job.tracked_date.startsWith(today)
            )
            .map((job) => job.company_id)
        ).size;

        // Calculate rejections
        let totalRejections = 0;
        let todayRejections = 0;

        data.forEach((job) => {
          job.status_events?.forEach((event) => {
            if (event.status === "rejected") {
              totalRejections++;
              if (event.timestamp && event.timestamp.startsWith(today)) {
                todayRejections++;
              }
            }
          });
        });

        // Update table cells
        document.getElementById("todayApps").textContent = todayApps;
        document.getElementById("totalApps").textContent = totalApps;
        document.getElementById("todayCompanies").textContent = todayCompanies;
        document.getElementById("totalCompanies").textContent = totalCompanies;
        document.getElementById("todayRejections").textContent =
          todayRejections;
        document.getElementById("totalRejections").textContent =
          totalRejections;

        // ...rest of the existing summary stats code...
        const totalJobs = data.length;
        const jobsWithSalary = data.filter(
          (job) => job.salary_low || job.salary_high
        ).length;

        const avgSalary =
          data
            .filter((job) => job.salary_low)
            .reduce((sum, job) => sum + job.salary_low, 0) / jobsWithSalary;

        document.getElementById("summary-stats").innerHTML += `
                <p>Total Jobs: ${totalJobs}</p>
                <p>Jobs with Salary Info: ${jobsWithSalary}</p>
                <p>Average Starting Salary: $${avgSalary.toFixed(2)}/hr</p>
            `;
      }

      function createSalaryChart(data) {
        const salaryRanges = {
          "0-20": 0, "21-30": 0, "31-40": 0, "41-50": 0,
          "51-60": 0, "61-70": 0, "71-80": 0, "81-100": 0, "100+": 0,
        };
        const salaryRangesAll = { ...salaryRanges };

        data.forEach((job) => {
          if (job.salary) {
            // Add to "All" chart unconditionally
            if (job.salary <= 20) salaryRangesAll["0-20"]++;
            else if (job.salary <= 30) salaryRangesAll["21-30"]++;
            else if (job.salary <= 40) salaryRangesAll["31-40"]++;
            else if (job.salary <= 50) salaryRangesAll["41-50"]++;
            else if (job.salary <= 60) salaryRangesAll["51-60"]++;
            else if (job.salary <= 70) salaryRangesAll["61-70"]++;
            else if (job.salary <= 80) salaryRangesAll["71-80"]++;
            else if (job.salary <= 100) salaryRangesAll["81-100"]++;
            else salaryRangesAll["100+"]++;

            // Only add to hourly chart if salary_period is 1
            if (job.salary_period === 1) {
              if (job.salary <= 20) salaryRanges["0-20"]++;
              else if (job.salary <= 30) salaryRanges["21-30"]++;
              else if (job.salary <= 40) salaryRanges["31-40"]++;
              else if (job.salary <= 50) salaryRanges["41-50"]++;
              else if (job.salary <= 60) salaryRanges["51-60"]++;
              else if (job.salary <= 70) salaryRanges["61-70"]++;
              else if (job.salary <= 80) salaryRanges["71-80"]++;
              else if (job.salary <= 100) salaryRanges["81-100"]++;
              else salaryRanges["100+"]++;
            }
          }
        });

        // Add debug logging
        console.log('Hourly only counts:', Object.values(salaryRanges).reduce((a, b) => a + b, 0));
        console.log('All salary counts:', Object.values(salaryRangesAll).reduce((a, b) => a + b, 0));

        // Calculate totals
        const hourlyTotal = Object.values(salaryRanges).reduce((a, b) => a + b, 0);
        const allTotal = Object.values(salaryRangesAll).reduce((a, b) => a + b, 0);

        const chartConfig = {
          type: "bar",
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: "#FFFFFF" },
                grid: { color: "rgba(255, 255, 255, 0.2)" },
              },
              x: {
                ticks: { color: "#FFFFFF" },
                grid: { color: "rgba(255, 255, 255, 0.2)" },
              },
            },
            plugins: {
              legend: {
                labels: { color: "#FFFFFF" },
              },
              title: {
                display: true,
                color: "#FFFFFF",
                text: '', // Will be set per chart
                padding: 10,
              }
            },
          },
        };

        // Hourly rates chart
        new Chart("salaryChart", {
          ...chartConfig,
          data: {
            labels: Object.keys(salaryRanges),
            datasets: [{
              label: `Hourly Jobs (Total: ${hourlyTotal})`,
              data: Object.values(salaryRanges),
              backgroundColor: "rgba(54, 162, 235, 0.8)",
            }],
          },
          options: {
            ...chartConfig.options,
            plugins: {
              ...chartConfig.options.plugins,
              title: {
                ...chartConfig.options.plugins.title,
                text: `Hourly Pay Distribution (${hourlyTotal} jobs)`
              }
            }
          }
        });

        // All salary data chart
        new Chart("salaryChartAll", {
          ...chartConfig,
          data: {
            labels: Object.keys(salaryRangesAll),
            datasets: [{
              label: `All Jobs (Total: ${allTotal})`,
              data: Object.values(salaryRangesAll),
              backgroundColor: "rgba(75, 192, 192, 0.8)",
            }],
          },
          options: {
            ...chartConfig.options,
            plugins: {
              ...chartConfig.options.plugins,
              title: {
                ...chartConfig.options.plugins.title,
                text: `All Pay Periods Distribution (${allTotal} jobs)`
              }
            }
          }
        });
      }

      function createDailyApplicationsChart(data) {
        let chartInstance = null;
        let processedData = null;

        const dateRangeButtons = document.querySelectorAll(
          ".chart-controls button"
        );

        dateRangeButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const days =
              this.getAttribute("data-value") === "all"
                ? null
                : parseInt(this.getAttribute("data-value"));
            updateChart(days);
          });
        });

        // Process all data once
        function processAllData() {
          if (processedData) return processedData;
          const dailyStats = {};

          // Process data to get daily counts
          data.forEach((job) => {
            if (job.tracked_date) {
              // Ensure consistent timezone handling
              const date = new Date(job.tracked_date);
              const dateStr = date.toISOString().split('T')[0];
              dailyStats[dateStr] = dailyStats[dateStr] || {
                totalApplications: 0,
                uniqueCompanies: new Set(),
                rejections: 0,
              };
              dailyStats[dateStr].totalApplications++;
              dailyStats[dateStr].uniqueCompanies.add(job.company_id);

              // Handle rejections with consistent timezone
              job.status_events?.forEach((event) => {
                if (event.status === "rejected" && event.timestamp) {
                  const rejectDate = new Date(event.timestamp).toISOString().split('T')[0];
                  dailyStats[rejectDate] = dailyStats[rejectDate] || {
                    totalApplications: 0,
                    uniqueCompanies: new Set(),
                    rejections: 0,
                  };
                  dailyStats[rejectDate].rejections++;
                }
              });
            }
          });
          
          // Debug output to check data for today
          const todayStr = new Date().toISOString().split('T')[0];
          console.log('Today:', todayStr);
          console.log('Data for today:', dailyStats[todayStr]);
          console.log('All dates with data:', Object.keys(dailyStats));
          // Generate all dates in the range
          const allDates = [];
          const startDate = new Date(
            Math.min(
              ...data.map((job) => new Date(job.tracked_date || "9999-12-31"))
            )
          );
          const endDate = new Date();

          for (
            let d = new Date(startDate);
            d <= endDate;
            d.setDate(d.getDate() + 1)
          ) {
            const dateStr = d.toISOString().split("T")[0];
            allDates.push(dateStr);
            if (!dailyStats[dateStr]) {
              dailyStats[dateStr] = {
                totalApplications: 0,
                uniqueCompanies: new Set(),
                rejections: 0,
              };
            }
          }

          return { dailyStats, allDates };
        }

        function updateChart(days = 7) {
          if (!processedData) {
            processedData = processAllData();
          }

          const { dailyStats, allDates } = processedData;

          // Slice the data based on selected date range
          const today = new Date();
          today.setHours(0, 0, 0, 0); // Set to start of today
          const todayStr = today.toISOString().split('T')[0];
          
          const slicedDates = days
            ? allDates.filter(date => {
                const dateObj = new Date(date);
                dateObj.setHours(0, 0, 0, 0);
                return dateObj >= new Date(today - (days - 1) * 24 * 60 * 60 * 1000) && 
                       dateObj <= today;
              }).sort()
            : allDates;

          // Make sure today is included even if no data
          if (!slicedDates.includes(todayStr)) {
            slicedDates.push(todayStr);
            dailyStats[todayStr] = {
              totalApplications: 0,
              uniqueCompanies: new Set(),
              rejections: 0
            };
          }

          const uniqueCompanies = slicedDates.map(
            (date) => dailyStats[date].uniqueCompanies.size
          );
          const totalApps = slicedDates.map(
            (date) =>
              dailyStats[date].totalApplications -
              dailyStats[date].uniqueCompanies.size
          );
          const rejections = slicedDates.map(
            (date) => dailyStats[date].rejections
          );

          if (chartInstance) {
            chartInstance.destroy();
          }

          chartInstance = new Chart("dailyApplicationsChart", {
            type: "bar",
            data: {
              labels: slicedDates,
              datasets: [
                {
                  label: "Rejections",
                  data: rejections,
                  type: "line",
                  borderColor: "rgba(255, 99, 132, 1)",
                  backgroundColor: "rgba(255, 99, 132, 0.0)",
                  borderWidth: 2,
                  order: 0, // Lower order means it will be drawn on top
                },
                {
                  label: "Unique Companies",
                  data: uniqueCompanies,
                  backgroundColor: "rgba(54, 162, 235, 0.8)",
                  stack: "Stack 0",
                  order: 1,
                },
                {
                  label: "Total Applications",
                  data: totalApps,
                  backgroundColor: "rgba(255, 159, 64, 0.8)",
                  stack: "Stack 0",
                  order: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                intersect: false,
                mode: "index",
              },
              scales: {
                x: {
                  stacked: true,
                  title: {
                    display: true,
                    text: "Date",
                    color: "#FFFFFF", // Set x-axis title color
                  },
                  ticks: { color: "#FFFFFF" }, // Set x-axis text color
                  grid: { color: "rgba(255, 255, 255, 0.2)" }, // Lighter grid lines
                },
                y: {
                  stacked: true,
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Count",
                    color: "#FFFFFF", // Set y-axis title color
                  },
                  ticks: { color: "#FFFFFF" }, // Set y-axis text color
                  grid: { color: "rgba(255, 255, 255, 0.2)" }, // Lighter grid lines
                },
                // Removed y1 axis
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    title: function (context) {
                      return new Date(context[0].label).toLocaleDateString();
                    },
                    label: function (context) {
                      const date = context.label;
                      if (context.dataset.label === "Total Applications") {
                        count = dailyStats[date].totalApplications;
                        return `Total Applications: ${count}`;
                      } else if (context.dataset.label === "Unique Companies") {
                        count = uniqueCompanies[context.dataIndex];
                        return `Unique Companies: ${count}`;
                      } else if (context.dataset.label === "Rejections") {
                        count = rejections[context.dataIndex];
                        return `Rejections: ${count}`;
                      }
                    },
                  },
                  titleColor: "#FFFFFF", // Tooltip title color
                  bodyColor: "#FFFFFF", // Tooltip body text color
                },
                legend: {
                  labels: {
                    color: "#FFFFFF", // Set legend text color
                  },
                },
              },
            },
          });
        }

        updateChart();
      }

      async function createJobMap(data) {
        const mapContainer = document.getElementById("jobMap");
        if (!mapContainer) {
          console.error("Map container not found!");
          return;
        }

        try {
          const map = L.map("jobMap", {
            center: [39.8283, -98.5795],
            zoom: 4,
            worldCopyJump: true,
          });

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "© OpenStreetMap contributors",
          }).addTo(map);

          const locationCounts = new Map();
          let remoteCount = 0;
          let hybridCount = 0;
          let totalCount = 0;

          // Process locations with multiple coordinates
          data.forEach((job) => {
            const location = job.job_posting_location;
            const coordinates = job.coordinates;

            if (!location) return;

            if (location.toLowerCase().includes("remote")) {
              remoteCount++;
              return;
            }
            if (location.toLowerCase().includes("hybrid")) {
              hybridCount++;
              return;
            }

            if (coordinates) {
              // Handle array of coordinate pairs
              for (let i = 0; i < coordinates.length; i += 1) {
                const lng = parseFloat(coordinates[i][1]);
                const lat = parseFloat(coordinates[i][0]);

                if (isValidCoordinate(lat, lng)) {
                  totalCount++;
                  const key = `${lat},${lng}`;
                  if (!locationCounts.has(key)) {
                    locationCounts.set(key, {
                      count: 0,
                      name: coordinates[i][2],
                      coords: [lat, lng],
                    });
                  }
                  locationCounts.get(key).count++;
                }
              }
            }
          });

          // Calculate max count for scaling
          const maxCount = Math.max(
            ...Array.from(locationCounts.values()).map((loc) => loc.count)
          );

          // Add circles to map
          locationCounts.forEach(({ count, name, coords }) => {
            const radius = Math.sqrt(count / maxCount) * 200000;

            const circle = L.circle(coords, {
              color: "#7C3AED",
              fillColor: "#7C3AED",
              fillOpacity: 0.1,
              radius: radius,
              weight: 1,
            }).addTo(map);

            const popupContent = `
                        <div style="color: black;">
                            <strong>Location:</strong>${name}<br>
                            <strong>Number of positions:</strong> ${count}
                        </div>
                    `;

            circle.bindPopup(popupContent);
            circle.on("mouseover", function (e) {
              this.setStyle({ fillOpacity: 0.8, weight: 2 });
              this.openPopup();
            });
            circle.on("mouseout", function (e) {
              this.setStyle({ fillOpacity: 0.1, weight: 1 });
              this.closePopup();
            });
          });

          document.getElementById("locationStats").innerHTML = `
                    <p>Remote Positions: ${remoteCount}</p>
                    <p>Hybrid Positions: ${hybridCount}</p>
                    <p>Unique Locations: ${locationCounts.size}</p>
                    <p>Total In-Person Positions: ${totalCount}</p>
                `;

          setTimeout(() => map.invalidateSize(true), 100);
        } catch (error) {
          console.error("Error creating map:", error);
        }
      }

      // Update coordinate validation to be more lenient
      function isValidCoordinate(lat, lng) {
        return (
          !isNaN(lat) &&
          !isNaN(lng) &&
          Math.abs(lat) <= 90 &&
          Math.abs(lng) <= 180
        );
      }
    </script>
  </body>
</html>
